{% extends "base.html" %}
{% block title %}Profilo{% endblock %}

{% block content %}

<h2>Profilo Utente</h2>

<div class="tabs">
    <button onclick="openTab('info')" class="active">Anagrafica</button>
    <button onclick="openTab('purchases')">Storico acquisti</button>
    <button onclick="openTab('resorts')">Comprensori salvati</button>
</div>

<!-- TAB ANAGRAFICA -->
<div id="info" class="tab-content active">
    <label for="firstname"></label><input id="firstname" value="{{ user.first_name }}">
    <label for="lastname"></label><input id="lastname" value="{{ user.last_name }}">
    <label for="email"></label><input id="email" value="{{ user.email }}">
    <button onclick="updateProfile()">Salva</button>
</div>

<!-- TAB ACQUISTI -->
<div id="purchases" class="tab-content">
    {% if purchases %}
        <ul>
        {% for p in purchases %}
            <li>{{ p.item }} – €{{ p.amount }} – {{ p.date.strftime('%d/%m/%Y') }}</li>
        {% endfor %}
        </ul>
    {% else %}
        <p>Nessun acquisto effettuato</p>
    {% endif %}
</div>

<!-- TAB RESORT SALVATI -->
<div id="resorts" class="tab-content">
    {% if saved_resorts %}
        <ul>
        {% for r in saved_resorts %}
            <li>{{ r.resort_name }} ({{ r.region }})</li>
        {% endfor %}
        </ul>
    {% else %}
        <p>Nessun comprensorio salvato</p>
    {% endif %}
</div>

<script>
function openTab(id) {
    document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    event.target.classList.add("active");
}
</script>
<script>
function updateProfile() {
    fetch("/profile/update", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            firstname: this.firstname.value,
            lastname: this.lastname.value,
            email: this.email.value
        })
    })
    .then(r => r.json())
    .then(d => {
        let msg;
        msg.innerText = d.success ? "Profilo aggiornato" : d.error;
    });
}

function changePassword() {
    let oldPassword;
    fetch("/profile/password", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            oldPassword: oldPassword.value,
            newPassword: this.newPassword.value
        })
    })
    .then(r => r.json())
    .then(d => {
        msg.innerText = d.success ? "Password aggiornata" : d.error;
    });
}
</script>
{% endblock %}
